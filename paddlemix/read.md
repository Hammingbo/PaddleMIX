### 标题:  
"缓解扩散模型训练数据的偏见问题：分布引导的无偏扩散模型"
---

### 引言:
本RFC提出了一种方法，旨在解决PaddleMIX在扩散模型训练过程中反映出训练数据集中存在的偏见。该方案借鉴了(https://arxiv.org/pdf/2402.18206) 中Distribution-guidacnce的核心思想，通过约束生成图像的属性分布，使其符合预设的公平分布。实现这一目标的关键在于：去噪 UNet 的潜层特征中包含丰富的人口统计语义，这些语义可以用于指导去偏生成。为此，可以训练一个属性分布预测器（Attribute Distribution Predictor, ADP），将潜在特征映射到属性分布上。ADP 的训练数据来源于现有属性分类器生成的伪标签。

---

### 问题描述:  
扩散模型（Diffusion Models, DMs）作为一种强大的生成模型广泛应用于数据增强和创意领域。然而，DMs会反映出训练数据集中存在的偏见，在面部图像的生成中尤为严重。例如模型可能偏向于生成某一特定人子群体的图像（如女性优于男性）。

---

### 解决方案:  
GitHub项目地址: [https://github.com/rishubhpar/debiasing_gen_models](https://github.com/rishubhpar/debiasing_gen_models)  
将OPERA的解码技术适配到单样本场景，核心方法包括：  
1. **属性分布预测器（ADP）：** 一种新颖的设置，用于在给定参考属性分布的情况下，无需重新训练扩散模型即可对现有扩散模型（DMs）进行去偏。具体而言，该方法训练了一个属性分布预测器（Attribute Distribution Predictor，ADP），它能够直接从扩散模型的h-space特征中预测属性分布。
2. **分布指导（DG）：** 分布指导（Distribution Guidance）用于在逆扩散过程中，根据参考属性分布进行条件生成。在扩散网络的中间特征空间（h-space）中引入指导机制，从而实现高效的数据训练和快速的图像生成。

---

### 方法细节:  

1. **数据集：**  
   我们以面部数据集为研究对象，因为这些数据集通常存在显著的人口统计偏差，如性别、种族等。利用预训练的属性预测模型，为CelebA-HQ每个图像生成伪标签,并利用去噪Unet提取图像的h-vcector，与对应的标签组成paris，用来训练ADP。

2. **分布引导：**  
   - 为了实现分布指导，我们通过 h-space 分类器构建了分布预测函数 ADP（Attribute Distribution Predictor）。  
   - 对于批次数据，获得其h-space特征和对应的属性标签，最后一个batch中的不同类别的softmax值相加作为分布估计。利用卡方散度损失来优化ADP。

3. **模型架构：**  
   - 一个在CelebA-HQ上预训练无条件扩散模型。
   - 一个文本条件扩散模型 Stable Diffusion v1.5，在 LAION数据集上训练。
   - 这两种模型都表现出不错的图像生成质量；然而，它们面部属性方面表现出显著的偏差。

4. **评估指标：**  
   - 图像质量和公平性。用于衡量生成图像这两个方面的指标。
   - 对于给定的属性𝑎，我们可以访问一个高准确度的属性分类器，基于该分类器的预测结果计算其与均匀向量的FD分数。FD分数越低，属性值的分布就越接近均匀分也就是说，生成的图像在属性𝑎上越公平。
   - 图像质量通过FID分数衡量，FID分数越低，图像质量越高。

5. **实施计划：**  
   - 将DG引导采样算法集成到PaddleMIX/ppdiffusers的采样pipeline中。  
   - 重写基于paddle实现的ADP训练，并集成到现有pipeline中。  

6. **交付内容：**  
   - 代码库更新：包括DG引导采样和ADP训练模块及相应代码测试。  
   - 文档更新：算法解释及使用指南。  